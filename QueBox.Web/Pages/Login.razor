// Login.razor
@page "/login"
@using QueBox.Models
@using QueBox.Services
@inject SignInManager<IdentityUser> SignInManager
@inject NavigationManager NavigationManager

<h3>Login</h3>

<EditForm  class="row g-3" Model="@editingUsuario" OnValidSubmit="@HandleLogin">

    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3 col-md-12">
        <label for="username"> Nombre:</label>
        <InputText id="username" @bind-Value="editingUsuario.Nombre" />
    </div>

    <div class="mb-3 col-md-12">
        <label for="password">Password:</label>
        <InputText type="password" id="password" @bind-Value="editingUsuario.Clave" />
    </div>

    <button type="submit" class="col-md-4 btn btn-primary">Login</button>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="text-danger">@ErrorMessage</p>
    }
</EditForm>

<div class="mb-3">
    <NavLink class="link" href="register">
        <span class="mb-2" aria-hidden="true"></span> Registrarse
    </NavLink>
</div>


@code {
    private List<Usuario> usuarios = new();
    private Usuario editingUsuario = new Usuario();
    private string ErrorMessage;
    private bool isLoading = true;

    private async Task HandleLogin()
    {
        var result = await SignInManager.PasswordSignInAsync(editingUsuario.Nombre, editingUsuario.Clave, isPersistent: false, lockoutOnFailure: false);

        if (result.Succeeded)
        {
            NavigationManager.NavigateTo("/"); // Redirect to home page
        }
        else
        {
            ErrorMessage = "Invalid login attempt.";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        usuarios = await UsuarioService.GetUsuariosAsync();
        isLoading = false;
    }


}